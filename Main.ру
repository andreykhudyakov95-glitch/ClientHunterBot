import json
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.enums.parse_mode import ParseMode

from config import TOKEN, ADMIN_ID, KEYWORDS, GROUPS

bot = Bot(token=TOKEN)
dp = Dispatcher()


def check_message(text: str):
    """–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π."""
    if not text:
        return False

    text_lower = text.lower()

    for kw in KEYWORDS:
        if kw in text_lower:
            # –∏—Å–∫–ª—é—á–µ–Ω–∏—è –æ—Ç —à—É–º–∞
            if "–º–µ–º" in text_lower:
                return False
            if "—à—É—Ç–∫" in text_lower:
                return False
            if "—é–º–æ—Ä" in text_lower:
                return False
            return True

    return False


@dp.message()
async def handler(msg: types.Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤."""
    try:
        chat_id = str(msg.chat.id)

        # –º–æ–Ω–∏—Ç–æ—Ä–∏–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
        if chat_id not in GROUPS:
            return

        content = msg.text or msg.caption
        if not content:
            return

        if check_message(content):
            link = None
            if msg.chat.username:
                link = f"https://t.me/{msg.chat.username}/{msg.message_id}"

            text = (
                f"üî• *–ù–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ!*\n\n"
                f"*–ß–∞—Ç:* {msg.chat.title}\n"
                f"*–¢–µ–∫—Å—Ç:* {content}\n"
            )

            if link:
                text += f"[–û—Ç–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ]({link})"

            await bot.send_message(ADMIN_ID, text, parse_mode=ParseMode.MARKDOWN)

    except Exception as e:
        await bot.send_message(ADMIN_ID, f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {e}")


async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
